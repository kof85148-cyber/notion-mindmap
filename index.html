<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeepMind Mobile - ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        :root { 
            --primary: #fb0; --bg: #0f111a; --card-bg: #1a1c26; 
            --text: #e0e0e0; --blue: #4fc3f7; --danger: #ff6b6b; --success: #66bb6a;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; margin: 0; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; display: flex; flex-direction: column; }
        
        /* --- é¦–é ç›´å¼ä½ˆå±€ --- */
        #home-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; }
        .home-header { padding: 20px 20px 10px; flex-shrink: 0; }
        .tag-scroller { display: flex; gap: 10px; overflow-x: auto; padding: 10px 20px; scrollbar-width: none; white-space: nowrap; border-bottom: 1px solid #333; }
        .tag-scroller::-webkit-scrollbar { display: none; }
        .tag-pill { padding: 6px 16px; background: #252833; border-radius: 20px; font-size: 13px; color: #aaa; border: 1px solid #444; flex-shrink: 0; }
        .tag-pill.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }

        .main-view { flex-grow: 1; padding: 15px; overflow-y: auto; }
        .card-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        /* ä¿®æ­£å¾Œçš„å¡ç‰‡æ¨£å¼ */
        .note-card { 
            background: var(--card-bg); padding: 18px; border-radius: 12px; 
            border: 1px solid #333; position: relative; display: flex; align-items: center; 
            justify-content: space-between; overflow: hidden;
        }
        .card-info { flex-grow: 1; pointer-events: none; } /* è®“æ–‡å­—ä¸å¹²æ“¾é»æ“Š */
        .card-del-btn { 
            color: var(--danger); padding: 15px; font-size: 20px; 
            position: relative; z-index: 10; font-weight: bold;
        }

        /* --- ç·¨è¼¯å™¨ç›´å¼å·¥å…·åˆ— --- */
        #editor-view { flex-grow: 1; display: none; flex-direction: column; }
        .toolbar { background: #15171f; border-bottom: 1px solid #333; padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .toolbar input { grid-column: span 2; background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 6px; }
        #cy { flex-grow: 1; background: radial-gradient(circle, #1a1c26 1px, #0f111a 1px); background-size: 25px 25px; }

        button { padding: 10px 5px; border-radius: 8px; border: 1px solid #444; background: #252833; color: #eee; font-size: 12px; font-weight: bold; }
        .btn-main { background: var(--primary); color: #000; border: none; }
        .btn-select-mode.active { background: var(--blue); color: #000; border-color: var(--blue); }

        #backup-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; padding: 20px; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 15px; width: 100%; border: 1px solid #444; }
        textarea { width: 100%; height: 180px; background: #000; color: var(--success); border: 1px solid #444; border-radius: 8px; margin: 10px 0; padding: 10px; font-size: 12px; }
        #inline-editor { position: absolute; display: none; z-index: 2000; border: 2px solid var(--primary); border-radius: 8px; padding: 10px; background: #222; color: white; font-size: 16px; width: 150px; }
    </style>
</head>
<body>

    <div id="backup-modal">
        <div class="modal-content">
            <h3 style="margin:0">å‚™ä»½/é‚„åŸæ–‡å­—ç‰ˆ</h3>
            <textarea id="backup-data" spellcheck="false"></textarea>
            <button onclick="copyBackupText()" style="width:100%; background: var(--success); color:#000; margin-bottom:10px;">ğŸ“‹ ä¸€éµè¤‡è£½</button>
            <div style="display:flex; gap: 10px;">
                <button onclick="document.getElementById('backup-modal').style.display='none'" style="flex:1">å–æ¶ˆ</button>
                <button onclick="importFromText()" style="flex:1; background: var(--blue); color:#000;">å°å…¥è¦†è“‹</button>
            </div>
        </div>
    </div>

    <div id="home-overlay">
        <div class="home-header">
            <h2 style="margin:0; color:var(--primary)">KeepMind</h2>
            <p style="font-size:12px; color:#666; margin:5px 0 0;">å¿ƒæ™ºåœ–ç­†è¨˜ Â· æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ</p>
        </div>
        <div class="tag-scroller" id="tagScroller"></div>
        <div class="main-view">
            <div class="card-grid" id="cardGrid"></div>
            <button class="btn-main" onclick="createNewNote()" style="width:100%; margin-top:20px; padding:15px; border-radius:30px; font-size:15px;">ï¼‹ æ–°å¢å¿ƒæ™ºåœ–ç­†è¨˜</button>
        </div>
        <div style="padding: 15px; border-top:1px solid #222;">
            <input type="text" id="new-tag-input" placeholder="+ æ–°å¢æ¨™ç±¤åˆ†é¡..." onkeypress="if(event.key==='Enter') addTag()" style="width:100%; background:#15171f; border:1px solid #333; color:white; padding:12px; border-radius:8px; outline:none;">
        </div>
    </div>

    <div id="editor-view">
        <div class="toolbar">
            <button onclick="saveAndExit()" class="btn-main">å„²å­˜è¿”å›</button>
            <input type="text" id="edit-title" placeholder="å‘½åç­†è¨˜...">
            <button onclick="openBackupModal()" class="btn-backup">å‚™ä»½</button>
            <button id="multi-select-btn" onclick="toggleMultiSelect()">é¸å–æ¨¡å¼</button>
            <button onclick="addNode()">ï¼‹æ–°ç¯€é»</button>
            <button onclick="removeSelected()" style="color:var(--danger)">ç§»é™¤é»</button>
            <button onclick="cy.fit()">ç½®ä¸­</button>
        </div>
        <div id="cy"></div>
        <input type="text" id="inline-editor">
    </div>

    <script>
        let notes = JSON.parse(localStorage.getItem('km_mobile_v2') || '[]');
        let tags = JSON.parse(localStorage.getItem('km_tags_mobile_v2') || '["å·¥ä½œ", "å€‹äºº"]');
        let currentNoteId = null;
        let currentTagFilter = 'all';
        let isMultiSelect = false;
        let cy = null;

        function initCy(elements = []) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                layout: { name: 'preset' },
                boxSelectionEnabled: true,
                style: [
                    { selector: 'node', style: {
                        'label': 'data(label)', 'color': '#fff', 'font-size': '12px', 'text-valign': 'bottom', 'text-margin-y': 6,
                        'background-color': '#1a1c26', 'border-width': 2, 'border-color': '#fb0', 'shape': 'ellipse',
                        'width': 22, 'height': 22, 'text-outline-width': 2, 'text-outline-color': '#0f111a'
                    }},
                    { selector: 'edge', style: { 'width': 1.5, 'line-color': '#555', 'curve-style': 'taxi', 'target-arrow-shape': 'circle', 'target-arrow-color': '#555' }},
                    { selector: ':selected', style: { 'border-color': '#fff', 'border-width': 3, 'background-color': '#444' }}
                ]
            });
            let isDragging = false;
            cy.on('drag', 'node:selected', function(e) {
                if (isDragging) return; isDragging = true;
                const node = e.target;
                const dx = node.position().x - node.data('prevX');
                const dy = node.position().y - node.data('prevY');
                cy.nodes(':selected').not(node).forEach(n => { n.position({ x: n.position().x + dx, y: n.position().y + dy }); });
                updatePositions(); isDragging = false;
            });
            cy.on('grab', 'node', updatePositions);
            function updatePositions() { cy.nodes().forEach(n => { n.data('prevX', n.position().x); n.data('prevY', n.position().y); }); }
            cy.on('tap', function(e) { 
                if (e.target === cy) { 
                    document.getElementById('inline-editor').style.display = 'none'; 
                    if (!isMultiSelect) cy.elements().unselect(); 
                } 
            });
            cy.on('tap', 'node', function(e) { if (!isMultiSelect) { cy.elements().unselect(); e.target.select(); } });
            cy.on('dbltap', 'node', function(e) {
                const target = e.target; const pos = e.renderedPosition;
                const input = document.getElementById('inline-editor');
                input.value = target.data('label') || ''; input.style.display = 'block';
                input.style.left = Math.min(window.innerWidth - 160, Math.max(10, pos.x - 75)) + 'px';
                input.style.top = (pos.y - 20) + 'px'; input.focus();
                input.onblur = input.onkeydown = function(evt) { if (evt.type === 'keydown' && evt.key !== 'Enter') return; target.data('label', input.value); input.style.display = 'none'; };
            });
        }

        function toggleMultiSelect() {
            isMultiSelect = !isMultiSelect;
            const btn = document.getElementById('multi-select-btn');
            btn.classList.toggle('active');
            btn.innerText = isMultiSelect ? "å¤šé¸ä¸­..." : "é¸å–æ¨¡å¼";
        }

        function openBackupModal() {
            const data = { title: document.getElementById('edit-title').value, elements: cy.elements().map(ele => ({ group: ele.isNode() ? 'nodes' : 'edges', data: ele.data(), position: ele.isNode() ? ele.position() : undefined })) };
            document.getElementById('backup-data').value = JSON.stringify(data);
            document.getElementById('backup-modal').style.display = 'flex';
        }

        async function copyBackupText() {
            try { await navigator.clipboard.writeText(document.getElementById('backup-data').value); alert("å·²è¤‡è£½ï¼"); } catch (err) { alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•å…¨é¸ã€‚"); }
        }

        function importFromText() {
            try {
                const parsed = JSON.parse(document.getElementById('backup-data').value);
                document.getElementById('edit-title').value = parsed.title || "åŒ¯å…¥ç­†è¨˜";
                initCy(parsed.elements); document.getElementById('backup-modal').style.display = 'none';
            } catch (e) { alert("æ ¼å¼éŒ¯èª¤ï¼"); }
        }

        function saveAndExit() {
            const elementsData = cy.elements().map(ele => ({ group: ele.isNode() ? 'nodes' : 'edges', data: ele.data(), position: ele.isNode() ? ele.position() : undefined }));
            const noteObj = { id: currentNoteId, title: document.getElementById('edit-title').value || "æœªå‘½åç­†è¨˜", tag: currentTagFilter === 'all' ? 'æœªåˆ†é¡' : currentTagFilter, data: elementsData };
            const idx = notes.findIndex(n => n.id === currentNoteId);
            if(idx > -1) notes[idx] = noteObj; else notes.unshift(noteObj);
            localStorage.setItem('km_mobile_v2', JSON.stringify(notes));
            document.getElementById('home-overlay').style.display = 'flex';
            document.getElementById('editor-view').style.display = 'none';
            renderCards();
        }

        function openNote(id) {
            const note = notes.find(n => n.id === id); currentNoteId = id;
            document.getElementById('edit-title').value = note.title;
            document.getElementById('home-overlay').style.display = 'none';
            document.getElementById('editor-view').style.display = 'flex';
            initCy(note.data); setTimeout(() => cy.fit(undefined, 40), 100);
        }

        function createNewNote() {
            currentNoteId = Date.now().toString(); document.getElementById('edit-title').value = '';
            document.getElementById('home-overlay').style.display = 'none'; document.getElementById('editor-view').style.display = 'flex';
            initCy([{ data: { id: 'root', label: 'ä¸­å¿ƒä¸»é¡Œ' }, position: {x:200, y:300} }]);
        }

        function renderSidebar() {
            const scroller = document.getElementById('tagScroller');
            scroller.innerHTML = `<div class="tag-pill ${currentTagFilter === 'all' ? 'active' : ''}" onclick="switchTag('all')">æ‰€æœ‰ç­†è¨˜</div>`;
            tags.forEach(t => { scroller.innerHTML += `<div class="tag-pill ${currentTagFilter === t ? 'active' : ''}" onclick="switchTag('${t}')">${t}</div>`; });
        }

        function addTag() {
            const input = document.getElementById('new-tag-input');
            if(input.value && !tags.includes(input.value)) { tags.push(input.value); localStorage.setItem('km_tags_mobile_v2', JSON.stringify(tags)); input.value = ''; renderSidebar(); }
        }

        function switchTag(t) { currentTagFilter = t; renderSidebar(); renderCards(); }

        function renderCards() {
            const grid = document.getElementById('cardGrid'); grid.innerHTML = '';
            notes.filter(n => currentTagFilter === 'all' || n.tag === currentTagFilter).forEach(n => {
                const card = document.createElement('div');
                card.className = 'note-card';
                // é»æ“Šå¡ç‰‡é–‹å•Ÿç­†è¨˜
                card.onclick = function(e) { openNote(n.id); };
                
                card.innerHTML = `
                    <div class="card-info">
                        <h3 style="margin:0; font-size:15px;">${n.title}</h3>
                        <span style="font-size:11px; color:var(--blue);"># ${n.tag}</span>
                    </div>
                    <div class="card-del-btn">âœ•</div>
                `;
                
                // å°ˆé–€è™•ç†åˆªé™¤æŒ‰éˆ•çš„é»æ“Š
                const delBtn = card.querySelector('.card-del-btn');
                delBtn.onclick = function(e) {
                    e.stopPropagation(); // é—œéµï¼šé˜»æ­¢é–‹å•Ÿç­†è¨˜
                    if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è¨˜ï¼Ÿ")) {
                        notes = notes.filter(item => item.id !== n.id);
                        localStorage.setItem('km_mobile_v2', JSON.stringify(notes));
                        renderCards();
                    }
                };
                
                grid.appendChild(card);
            });
        }

        function addNode() {
            const sel = cy.$(':selected')[0] || cy.nodes()[0]; const id = 'n' + Date.now();
            cy.add([{ group: 'nodes', data: { id, label: 'æ–°ç¯€é»' }, position: { x: sel.position().x + 80, y: sel.position().y + 80 } }, { group: 'edges', data: { source: sel.id(), target: id } }]);
        }
        function removeSelected() { cy.$(':selected').remove(); }

        window.onload = () => { renderSidebar(); renderCards(); };
    </script>
</body>
</html>
