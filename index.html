<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeepMind Mobile - ç©©å®šç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        :root { 
            --primary: #fb0; --bg: #0f111a; --card-bg: #1a1c26; 
            --text: #e0e0e0; --blue: #4fc3f7; --danger: #ff6b6b; --success: #66bb6a;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: -apple-system, sans-serif; margin: 0; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; display: flex; flex-direction: column; }
        
        /* --- ä¿®æ­£å¡ç‰‡èˆ‡åˆªé™¤éµ --- */
        #home-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; }
        .tag-scroller { display: flex; gap: 10px; overflow-x: auto; padding: 10px 20px; border-bottom: 1px solid #333; }
        .tag-pill { padding: 6px 16px; background: #252833; border-radius: 20px; font-size: 13px; color: #aaa; border: 1px solid #444; flex-shrink: 0; }
        .tag-pill.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }

        .main-view { flex-grow: 1; padding: 15px; overflow-y: auto; }
        .card-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        .note-card { 
            background: var(--card-bg); border-radius: 12px; border: 1px solid #333; 
            display: flex; align-items: stretch; min-height: 80px; position: relative;
        }
        .card-body { flex-grow: 1; padding: 18px; display: flex; flex-direction: column; justify-content: center; }
        .card-del-zone { 
            width: 70px; display: flex; align-items: center; justify-content: center; 
            background: rgba(255,107,107,0.1); border-left: 1px solid #333;
            color: var(--danger); font-size: 24px; font-weight: bold;
        }
        .card-del-zone:active { background: var(--danger); color: #fff; }

        /* --- ç·¨è¼¯å™¨å·¥å…·åˆ— --- */
        #editor-view { flex-grow: 1; display: none; flex-direction: column; }
        .toolbar { background: #15171f; border-bottom: 1px solid #333; padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .toolbar input { grid-column: span 2; background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 6px; font-size: 14px; }
        
        #cy { flex-grow: 1; background: radial-gradient(circle, #1a1c26 1px, #0f111a 1px); background-size: 25px 25px; }

        button { padding: 12px 5px; border-radius: 8px; border: 1px solid #444; background: #252833; color: #eee; font-size: 12px; font-weight: bold; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-main { background: var(--primary); color: #000; border: none; }
        .btn-mode.active { background: var(--blue); color: #000; border-color: var(--blue); }

        #backup-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; padding: 20px; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 15px; width: 100%; border: 1px solid #444; }
        textarea { width: 100%; height: 180px; background: #000; color: var(--success); border: 1px solid #444; margin: 10px 0; padding: 10px; font-size: 12px; }
        #inline-editor { position: absolute; display: none; z-index: 2000; border: 2px solid var(--primary); border-radius: 8px; padding: 10px; background: #222; color: white; width: 150px; }
    </style>
</head>
<body>

    <div id="backup-modal">
        <div class="modal-content">
            <h3 style="margin:0">å‚™ä»½/é‚„åŸæ–‡å­—ç‰ˆ</h3>
            <textarea id="backup-data" spellcheck="false"></textarea>
            <button onclick="copyBackupText()" style="width:100%; background: var(--success); color:#000; margin-bottom:10px;">ğŸ“‹ é»æˆ‘ä¸€éµè¤‡è£½</button>
            <div style="display:flex; gap: 10px;">
                <button onclick="document.getElementById('backup-modal').style.display='none'" style="flex:1">å–æ¶ˆ</button>
                <button onclick="importFromText()" style="flex:1; background: var(--blue); color:#000;">å°å…¥è¦†è“‹</button>
            </div>
        </div>
    </div>

    <div id="home-overlay">
        <div style="padding: 20px 20px 10px;">
            <h2 style="margin:0; color:var(--primary)">KeepMind</h2>
            <p style="font-size:12px; color:#666; margin:5px 0 0;">æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ Â· æ“ä½œä¿®æ­£</p>
        </div>
        <div class="tag-scroller" id="tagScroller"></div>
        <div class="main-view">
            <div class="card-grid" id="cardGrid"></div>
            <button class="btn-main" onclick="createNewNote()" style="width:100%; margin-top:20px; padding:15px; border-radius:30px; font-size:15px;">ï¼‹ æ–°å¢å¿ƒæ™ºåœ–ç­†è¨˜</button>
        </div>
        <div style="padding: 15px; border-top:1px solid #222;">
            <input type="text" id="new-tag-input" placeholder="+ æ–°å¢æ¨™ç±¤..." onkeypress="if(event.key==='Enter') addTag()">
        </div>
    </div>

    <div id="editor-view">
        <div class="toolbar">
            <button onclick="saveAndExit()" class="btn-main">å„²å­˜è¿”å›</button>
            <input type="text" id="edit-title" placeholder="æ¨™é¡Œ">
            <button onclick="openBackupModal()">å‚™ä»½</button>
            <button id="multi-select-btn" onclick="toggleMultiSelect()" class="btn-mode">é¸å–æ¨¡å¼</button>
            <button onclick="addNode()">ï¼‹æ–°é»</button>
            <button onclick="removeSelected()" style="color:var(--danger)">ç§»é™¤é»</button>
            <button onclick="cy.fit()">ç½®ä¸­</button>
        </div>
        <div id="cy"></div>
        <input type="text" id="inline-editor">
    </div>

    <script>
        let notes = JSON.parse(localStorage.getItem('km_mobile_v3') || '[]');
        let tags = JSON.parse(localStorage.getItem('km_tags_v3') || '["é è¨­"]');
        let currentNoteId = null;
        let currentTagFilter = 'all';
        let isMultiSelect = false;
        let cy = null;

        function initCy(elements = []) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                layout: { name: 'preset' },
                style: [
                    { selector: 'node', style: {
                        'label': 'data(label)', 'color': '#fff', 'font-size': '12px', 'text-valign': 'bottom', 'text-margin-y': 6,
                        'background-color': '#1a1c26', 'border-width': 2, 'border-color': '#fb0', 'shape': 'ellipse',
                        'width': 22, 'height': 22, 'text-outline-width': 2, 'text-outline-color': '#0f111a'
                    }},
                    { selector: 'edge', style: { 'width': 1.5, 'line-color': '#555', 'curve-style': 'taxi', 'target-arrow-shape': 'circle', 'target-arrow-color': '#555' }},
                    { selector: ':selected', style: { 'border-color': '#fff', 'border-width': 3, 'background-color': '#444' }}
                ]
            });

            // ä¿®æ­£å¤šé¸æ¨¡å¼
            cy.on('tap', 'node', function(e) {
                if (isMultiSelect) {
                    if (e.target.selected()) e.target.unselect();
                    else e.target.select();
                } else {
                    cy.elements().unselect();
                    e.target.select();
                }
            });

            // ç¾¤çµ„ç§»å‹•
            let isDragging = false;
            cy.on('drag', 'node:selected', function(e) {
                if (isDragging) return; isDragging = true;
                const node = e.target;
                const dx = node.position().x - node.data('prevX');
                const dy = node.position().y - node.data('prevY');
                cy.nodes(':selected').not(node).forEach(n => { n.position({ x: n.position().x + dx, y: n.position().y + dy }); });
                updatePositions(); isDragging = false;
            });
            cy.on('grab', 'node', updatePositions);
            function updatePositions() { cy.nodes().forEach(n => { n.data('prevX', n.position().x); n.data('prevY', n.position().y); }); }

            // é›™æ“Šç·¨è¼¯
            cy.on('dbltap', 'node', function(e) {
                const target = e.target; const pos = e.renderedPosition;
                const input = document.getElementById('inline-editor');
                input.value = target.data('label') || ''; input.style.display = 'block';
                input.style.left = Math.min(window.innerWidth - 160, Math.max(10, pos.x - 75)) + 'px';
                input.style.top = (pos.y - 20) + 'px'; input.focus();
                input.onblur = input.onkeydown = function(evt) { if (evt.type === 'keydown' && evt.key !== 'Enter') return; target.data('label', input.value); input.style.display = 'none'; };
            });
        }

        function toggleMultiSelect() {
            isMultiSelect = !isMultiSelect;
            document.getElementById('multi-select-btn').classList.toggle('active');
            document.getElementById('multi-select-btn').innerText = isMultiSelect ? "å¤šé¸ä¸­" : "é¸å–æ¨¡å¼";
        }

        // --- ç®¡ç†åŠŸèƒ½ ---
        function renderCards() {
            const grid = document.getElementById('cardGrid'); grid.innerHTML = '';
            notes.filter(n => currentTagFilter === 'all' || n.tag === currentTagFilter).forEach(n => {
                const card = document.createElement('div');
                card.className = 'note-card';
                
                // çµæ§‹åŒ–å¡ç‰‡å…§å®¹
                card.innerHTML = `
                    <div class="card-body" onclick="openNote('${n.id}')">
                        <h3 style="margin:0; font-size:15px;">${n.title || 'æœªå‘½å'}</h3>
                        <span style="font-size:11px; color:var(--blue);"># ${n.tag}</span>
                    </div>
                    <div class="card-del-zone" onclick="confirmDelete('${n.id}', event)">âœ•</div>
                `;
                grid.appendChild(card);
            });
        }

        function confirmDelete(id, event) {
            event.stopPropagation(); // é˜»æ­¢é€²å…¥ç­†è¨˜
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è¨˜ï¼Ÿé€™ç„¡æ³•æ’¤éŠ·ã€‚")) {
                notes = notes.filter(item => item.id !== id);
                localStorage.setItem('km_mobile_v3', JSON.stringify(notes));
                renderCards();
            }
        }

        function openNote(id) {
            const note = notes.find(n => n.id === id); currentNoteId = id;
            document.getElementById('edit-title').value = note.title;
            document.getElementById('home-overlay').style.display = 'none';
            document.getElementById('editor-view').style.display = 'flex';
            initCy(note.data); setTimeout(() => cy.fit(undefined, 40), 100);
        }

        function createNewNote() {
            currentNoteId = Date.now().toString();
            document.getElementById('home-overlay').style.display = 'none';
            document.getElementById('editor-view').style.display = 'flex';
            initCy([{ data: { id: 'root', label: 'ä¸­å¿ƒä¸»é¡Œ' }, position: {x:200, y:300} }]);
        }

        function saveAndExit() {
            const elementsData = cy.elements().map(ele => ({ group: ele.isNode() ? 'nodes' : 'edges', data: ele.data(), position: ele.isNode() ? ele.position() : undefined }));
            const noteObj = { id: currentNoteId, title: document.getElementById('edit-title').value, tag: currentTagFilter === 'all' ? 'é è¨­' : currentTagFilter, data: elementsData };
            const idx = notes.findIndex(n => n.id === currentNoteId);
            if(idx > -1) notes[idx] = noteObj; else notes.unshift(noteObj);
            localStorage.setItem('km_mobile_v3', JSON.stringify(notes));
            document.getElementById('home-overlay').style.display = 'flex';
            document.getElementById('editor-view').style.display = 'none';
            renderCards();
        }

        // --- æ¨™ç±¤åŠŸèƒ½ ---
        function renderSidebar() {
            const scroller = document.getElementById('tagScroller');
            scroller.innerHTML = `<div class="tag-pill ${currentTagFilter === 'all' ? 'active' : ''}" onclick="switchTag('all')">æ‰€æœ‰ç­†è¨˜</div>`;
            tags.forEach(t => { scroller.innerHTML += `<div class="tag-pill ${currentTagFilter === t ? 'active' : ''}" onclick="switchTag('${t}')">${t}</div>`; });
        }
        function addTag() {
            const input = document.getElementById('new-tag-input');
            if(input.value && !tags.includes(input.value)) { tags.push(input.value); localStorage.setItem('km_tags_v3', JSON.stringify(tags)); input.value = ''; renderSidebar(); }
        }
        function switchTag(t) { currentTagFilter = t; renderSidebar(); renderCards(); }

        // --- å‚™ä»½ç³»çµ± ---
        function openBackupModal() {
            const data = { title: document.getElementById('edit-title').value, elements: cy.elements().map(ele => ({ group: ele.isNode() ? 'nodes' : 'edges', data: ele.data(), position: ele.isNode() ? ele.position() : undefined })) };
            document.getElementById('backup-data').value = JSON.stringify(data);
            document.getElementById('backup-modal').style.display = 'flex';
        }
        async function copyBackupText() {
            try { await navigator.clipboard.writeText(document.getElementById('backup-data').value); alert("ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"); } catch (err) { alert("è¤‡è£½å¤±æ•—"); }
        }
        function importFromText() {
            try {
                const parsed = JSON.parse(document.getElementById('backup-data').value);
                document.getElementById('edit-title').value = parsed.title;
                initCy(parsed.elements); document.getElementById('backup-modal').style.display = 'none';
            } catch (e) { alert("æ ¼å¼éŒ¯èª¤ï¼"); }
        }

        function addNode() {
            const sel = cy.$(':selected')[0] || cy.nodes()[0]; const id = 'n' + Date.now();
            cy.add([{ group: 'nodes', data: { id, label: 'æ–°é»' }, position: { x: sel.position().x + 80, y: sel.position().y + 80 } }, { group: 'edges', data: { source: sel.id(), target: id } }]);
        }
        function removeSelected() { cy.$(':selected').remove(); }

        window.onload = () => { renderSidebar(); renderCards(); };
    </script>
</body>
</html>
