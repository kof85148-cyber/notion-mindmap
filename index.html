<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>KeepMind - Notion Edition (Auto-Compress)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        :root { --primary: #fb0; --bg: #ffffff; --border: #edeef0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); color: #37352f; }
        
        /* å·¥å…·æ¬„ */
        .toolbar { padding: 8px 16px; background: #f7f7f5; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .editor-container { display: flex; flex-grow: 1; overflow: hidden; }
        
        /* å·¦å´æ–‡å­— */
        #text-outline { width: 280px; border: none; border-right: 1px solid var(--border); padding: 20px; font-size: 14px; line-height: 1.6; outline: none; background: #fff; resize: none; }
        
        /* å³å´åœ–è¡¨ */
        #cy-container { flex-grow: 1; position: relative; background: #fff; }
        #cy { width: 100%; height: 100%; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button { padding: 6px 12px; border: 1px solid #d3d3d2; border-radius: 4px; background: white; cursor: pointer; font-size: 13px; color: #37352f; }
        button:hover { background: #efefef; }
        .btn-primary { background: var(--primary); border-color: #eeb000; font-weight: 600; }
        
        /* åº•éƒ¨åŒæ­¥å€ */
        .sync-bar { background: #f7f7f5; padding: 10px 16px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center; font-size: 12px; }
        #json-input { flex-grow: 1; padding: 6px; border: 1px solid var(--border); border-radius: 3px; font-family: monospace; }
        
        /* ç¯€é»ç·¨è¼¯æµ®çª— */
        #floating-edit { position: absolute; bottom: 20px; right: 20px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; border: 1px solid var(--primary); z-index: 10; }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn-primary" onclick="addNode()">ï¼‹ æ–°å¢åˆ†æ”¯</button>
        <button onclick="document.getElementById('imgInput').click()">ğŸ–¼ï¸ æ’å…¥åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</button>
        <button onclick="cy.fit()">ğŸ¯ ç•«é¢å±…ä¸­</button>
        <div style="flex-grow: 1;"></div>
        <button onclick="copyData()">ğŸ“‹ è¤‡è£½ JSON å­˜æª”</button>
        <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="processImage(event)">
    </div>

    <div class="editor-container">
        <textarea id="text-outline" placeholder="è¼¸å…¥ç¸®æ’æ–‡å­—...&#10;  ä¾‹å¦‚ï¼š&#10;  ä¸»é¡Œ&#10;    å­ç¯€é»" oninput="syncToMap()"></textarea>
        <div id="cy-container">
            <div id="cy"></div>
            <div id="floating-edit">
                <input type="text" id="node-label-edit" oninput="updateNodeLabel()" style="padding: 5px; width: 150px;" placeholder="ä¿®æ”¹åç¨±...">
            </div>
        </div>
    </div>

    <div class="sync-bar">
        <span>é‚„åŸå­˜æª”:</span>
        <input type="text" id="json-input" placeholder="è²¼ä¸Š Notion Code Block çš„ JSON æ•¸æ“š...">
        <button onclick="importData()">ğŸ“¥ åŒ¯å…¥</button>
    </div>

    <script>
        let cy = null;
        let isSyncing = false;

        function initCy(elements = []) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements.length ? elements : [{ data: { id: 'root', label: 'ä¸­å¿ƒä¸»é¡Œ' } }],
                style: [
                    { selector: 'node', style: {
                        'label': 'data(label)',
                        'background-color': '#fff',
                        'border-width': 2,
                        'border-color': '#fb0',
                        'shape': 'round-rectangle',
                        'width': 'label',
                        'height': 'label',
                        'padding': '10px',
                        'text-valign': 'bottom',
                        'text-margin-y': 5,
                        'font-size': '12px',
                        'background-image': 'data(image)',
                        'background-fit': 'cover',
                        'background-image-opacity': 1
                    }},
                    { selector: 'node:selected', style: { 'border-width': 4, 'border-color': '#333' }},
                    { selector: 'edge', style: { 'width': 2, 'line-color': '#ccc', 'curve-style': 'taxi' }}
                ],
                minZoom: 0.1, maxZoom: 3.0
            });

            cy.on('tap', 'node', (e) => {
                const panel = document.getElementById('floating-edit');
                panel.style.display = 'block';
                document.getElementById('node-label-edit').value = e.target.data('label');
                document.getElementById('node-label-edit').focus();
            });

            cy.on('tap', (e) => { if(e.target === cy) document.getElementById('floating-edit').style.display = 'none'; });
            cy.on('data dragfree add remove', () => { if(!isSyncing) syncToText(); });
        }

        // --- é›™å‘åŒæ­¥ ---
        function syncToText() {
            if (isSyncing) return;
            isSyncing = true;
            let root = cy.$('#root').length ? cy.$('#root') : cy.nodes()[0];
            if(!root) { isSyncing = false; return; }
            let output = "";
            function traverse(node, depth) {
                output += "  ".repeat(depth) + node.data('label') + "\n";
                node.outgoers('node').forEach(child => traverse(child, depth + 1));
            }
            traverse(root, 0);
            document.getElementById('text-outline').value = output.trimEnd();
            isSyncing = false;
        }

        function syncToMap() {
            if (isSyncing) return;
            isSyncing = true;
            const lines = document.getElementById('text-outline').value.split('\n');
            let newElems = [];
            let stack = [];
            lines.forEach((line, i) => {
                let content = line.trim(); if(!content) return;
                let depth = line.search(/\S/);
                let id = i === 0 ? 'root' : 'n' + i;
                newElems.push({ data: { id, label: content, image: findOldImage(content) }});
                while(stack.length > 0 && stack[stack.length-1].depth >= depth) stack.pop();
                if(stack.length > 0) newElems.push({ data: { source: stack[stack.length-1].id, target: id }});
                stack.push({ id, depth });
            });
            if(newElems.length) {
                cy.json({ elements: newElems });
                cy.layout({ name: 'breadthfirst', directed: true, padding: 30 }).run();
            }
            isSyncing = false;
        }

        function findOldImage(label) {
            let old = cy.nodes().filter(n => n.data('label') === label)[0];
            return old ? old.data('image') : '';
        }

        function updateNodeLabel() {
            const sel = cy.$(':selected')[0];
            if(sel) {
                sel.data('label', document.getElementById('node-label-edit').value);
                syncToText();
            }
        }

        // --- æ ¸å¿ƒï¼šåœ–ç‰‡è‡ªå‹•å£“ç¸®åŠŸèƒ½ ---
        function processImage(event) {
            const sel = cy.$(':selected')[0];
            if(!sel) return alert("è«‹å…ˆé¸å–ä¸€å€‹ç¯€é»");
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 300; // é™åˆ¶æœ€å¤§å¯¬åº¦ç‚º 300px
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_WIDTH) { width *= MAX_WIDTH / height; height = MAX_WIDTH; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // è¼¸å‡ºç‚ºå£“ç¸®å¾Œçš„ Base64 JPEG
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7); // 0.7 ç‚ºè³ªé‡è¨­å®š
                    sel.data('image', compressedBase64);
                    sel.style({'width': 80, 'height': 80}); // çµ±ä¸€å£“ç¸®å¾Œç¯€é»å¤§å°
                };
            };
        }

        // --- Notion æ•¸æ“šæ“ä½œ ---
        function copyData() {
            const data = JSON.stringify(cy.json().elements);
            navigator.clipboard.writeText(data);
            alert("æˆåŠŸè¤‡è£½ JSONï¼è«‹è²¼åˆ° Notion çš„ç¨‹å¼ç¢¼å€å¡Šå­˜æª”ã€‚");
        }

        function importData() {
            const val = document.getElementById('json-input').value;
            if(!val) return;
            try {
                const elems = JSON.parse(val);
                initCy(elems);
                syncToText();
                cy.fit();
            } catch(e) { alert("ç„¡æ•ˆçš„ JSON æ•¸æ“š"); }
        }

        function addNode() {
            const sel = cy.$(':selected')[0] || cy.nodes()[0];
            const id = 'n' + Date.now();
            cy.add([{ group:'nodes', data:{ id, label:'æ–°ç¯€é»'}, position:{ x:sel.position().x+150, y:sel.position().y }},
                    { group:'edges', data:{ source:sel.id(), target:id }}]);
        }

        initCy();
    </script>
</body>
</html>