<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeepMind - Notion è¡Œå‹•å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        :root { 
            --sidebar-w: 240px; --primary: #fb0; --bg: #0f111a; --card-bg: #1a1c26; 
            --text: #e0e0e0; --blue: #4fc3f7; --danger: #ff6b6b; --success: #66bb6a;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; height: 100vh; background: var(--bg); color: var(--text); display: flex; overflow: hidden; touch-action: manipulation; }
        
        /* --- ç®¡ç†é¦–é  --- */
        #home-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; }
        @media (min-width: 768px) { #home-overlay { flex-direction: row; } }

        .sidebar { width: 100%; background: #15171f; padding: 15px 0; border-bottom: 1px solid #333; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .sidebar { width: var(--sidebar-w); border-bottom: none; border-right: 1px solid #333; } }

        .sidebar-header { padding: 0 20px 10px; font-size: 20px; font-weight: bold; color: var(--primary); }
        .sidebar-item { padding: 12px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #aaa; font-size: 14px; border-bottom: 1px solid #222; }
        .sidebar-item.active { background: #2c2100; color: var(--primary); font-weight: bold; }

        .main-view { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .note-card { background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid #333; cursor: pointer; position: relative; height: 90px; display: flex; flex-direction: column; justify-content: space-between; }
        .card-del-btn { position: absolute; top: 8px; right: 8px; color: #555; font-size: 18px; padding: 5px; }

        /* --- ç·¨è¼¯å™¨ä»‹é¢ --- */
        #editor-view { flex-grow: 1; display: none; flex-direction: column; background: var(--bg); position: relative; z-index: 1000; }
        .toolbar { padding: 8px 12px; background: #15171f; border-bottom: 1px solid #333; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        #cy { flex-grow: 1; background: radial-gradient(circle, #1a1c26 1px, #0f111a 1px); background-size: 30px 30px; }
        
        /* æŒ‰éˆ•å„ªåŒ– */
        button { padding: 10px 14px; border-radius: 6px; border: 1px solid #444; background: #252833; color: #ccc; cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-save { background: var(--primary); color: #000; border: none; }
        .btn-mode { background: #3a3f4b; color: #fff; }
        .btn-mode.active { background: var(--blue); color: #000; box-shadow: 0 0 10px var(--blue); }
        .btn-backup { background: #2c2e3a; }

        /* å½ˆçª—å„ªåŒ– */
        #backup-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: none; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 12px; width: 100%; max-width: 500px; border: 1px solid #333; }
        textarea { width: 100%; height: 200px; background: #000; color: var(--success); border: 1px solid #444; font-family: monospace; font-size: 12px; margin: 10px 0; padding: 10px; box-sizing: border-box; border-radius: 4px; }
        
        #inline-editor { position: absolute; display: none; z-index: 2000; border: 1px solid var(--primary); border-radius: 4px; padding: 8px; background: #222; color: white; outline: none; font-size: 16px; }
    </style>
</head>
<body>

    <div id="backup-modal">
        <div class="modal-content">
            <h3 style="margin:0; font-size: 18px;">æ–‡å­—ç‰ˆå‚™ä»½/é‚„åŸ</h3>
            <textarea id="backup-data" placeholder="åœ¨æ­¤è²¼ä¸Šä»£ç¢¼..." spellcheck="false"></textarea>
            <div style="display:flex; flex-direction: column; gap: 10px;">
                <button onclick="copyBackupText()" style="background: var(--success); color: #000; font-weight: bold; border:none;">ğŸ“‹ ä¸€éµè¤‡è£½ä»£ç¢¼</button>
                <div style="display:flex; gap: 10px;">
                    <button onclick="document.getElementById('backup-modal').style.display='none'" style="flex:1">å–æ¶ˆ</button>
                    <button onclick="importFromText()" style="background: var(--blue); color: #000; border:none; font-weight:bold; flex:1">å°å…¥ä¸¦è¦†è“‹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="home-overlay">
        <div class="sidebar">
            <div class="sidebar-header">KeepMind</div>
            <div id="tab-all" class="sidebar-item active" onclick="switchTag('all')">ğŸ“ æ‰€æœ‰ç­†è¨˜</div>
            <div id="tag-list"></div>
            <div style="padding: 10px 20px;">
                <input type="text" id="new-tag-input" placeholder="+ æ–°å¢æ¨™ç±¤..." onkeypress="if(event.key==='Enter') addTag()" style="width:100%; background:#1a1c26; border:1px solid #444; color:white; padding:10px; border-radius:6px; outline:none;">
            </div>
        </div>
        <div class="main-view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="current-view-title" style="margin:0; font-size: 18px;">ç­†è¨˜ç¸½è¦½</h2>
                <button class="btn-save" onclick="createNewNote()">ï¼‹ æ–°å¢ç­†è¨˜</button>
            </div>
            <div class="card-grid" id="cardGrid"></div>
        </div>
    </div>

    <div id="editor-view">
        <div class="toolbar">
            <button onclick="saveAndExit()" class="btn-save">å„²å­˜</button>
            <input type="text" id="edit-title" placeholder="æ¨™é¡Œ" style="background:#1a1c26; border:1px solid #444; color:white; padding:10px; border-radius:6px; width:100px; flex-grow:1;">
            <button id="multi-select-btn" class="btn-mode" onclick="toggleMultiSelect()">é¸å–æ¨¡å¼: é—œ</button>
            <button onclick="addNode('child')">ï¼‹å­é»</button>
            <button onclick="removeSelected()" style="color:var(--danger)">ğŸ—‘</button>
            <button onclick="openBackupModal()" class="btn-backup">ğŸ“‚ å‚™ä»½</button>
        </div>
        <div id="cy"></div>
        <input type="text" id="inline-editor">
    </div>

    <script>
        let notes = JSON.parse(localStorage.getItem('km_notion_v1') || '[]');
        let tags = JSON.parse(localStorage.getItem('km_tags_notion_v1') || '["å·¥ä½œ", "å­¸ç¿’"]');
        let currentNoteId = null;
        let currentTagFilter = 'all';
        let isMultiSelect = false;
        let cy = null;

        function initCy(elements = []) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                layout: { name: 'preset' },
                boxSelectionEnabled: true,
                style: [
                    { selector: 'node', style: {
                        'label': 'data(label)', 'color': '#fff', 'font-size': '12px', 'text-valign': 'bottom', 'text-margin-y': 8,
                        'background-color': '#1a1c26', 'border-width': 2, 'border-color': '#fb0', 'shape': 'ellipse',
                        'width': 25, 'height': 25, 'text-outline-width': 2, 'text-outline-color': '#0f111a'
                    }},
                    { selector: 'edge', style: {
                        'width': 1.5, 'line-color': '#555', 'curve-style': 'taxi', 'target-arrow-shape': 'circle', 'target-arrow-color': '#555'
                    }},
                    { selector: ':selected', style: { 'border-color': '#fff', 'border-width': 3, 'background-color': '#444' }}
                ]
            });

            // æ‰‹æ©Ÿç‰ˆç¾¤çµ„ç§»å‹•æ”¯æ´
            let isDragging = false;
            cy.on('drag', 'node:selected', function(e) {
                if (isDragging) return; isDragging = true;
                const node = e.target;
                const dx = node.position().x - node.data('prevX');
                const dy = node.position().y - node.data('prevY');
                cy.nodes(':selected').not(node).forEach(n => { n.position({ x: n.position().x + dx, y: n.position().y + dy }); });
                updatePositions(); isDragging = false;
            });
            cy.on('grab', 'node', updatePositions);
            function updatePositions() { cy.nodes().forEach(n => { n.data('prevX', n.position().x); n.data('prevY', n.position().y); }); }

            // é›™æ“Šç·¨è¼¯ (æ‰‹æ©Ÿç‰ˆé€£æŒ‰å…©ä¸‹)
            const input = document.getElementById('inline-editor');
            cy.on('tap', 'node', function(e) {
                if (!isMultiSelect) {
                    cy.elements().unselect();
                    e.target.select();
                }
            });

            cy.on('dbltap', 'node', function(e) {
                const target = e.target; const pos = e.renderedPosition;
                input.value = target.data('label') || ''; input.style.display = 'block';
                input.style.left = (pos.x - 50) + 'px'; input.style.top = (pos.y - 15) + 'px';
                input.focus();
                input.onblur = input.onkeydown = function(evt) {
                    if (evt.type === 'keydown' && evt.key !== 'Enter') return;
                    target.data('label', input.value); input.style.display = 'none';
                };
            });
        }

        // --- å¤šé¸æ¨¡å¼åˆ‡æ› (æ‰‹æ©Ÿæ ¸å¿ƒåŠŸèƒ½) ---
        function toggleMultiSelect() {
            isMultiSelect = !isMultiSelect;
            const btn = document.getElementById('multi-select-btn');
            btn.innerText = isMultiSelect ? "é¸å–æ¨¡å¼: é–‹" : "é¸å–æ¨¡å¼: é—œ";
            btn.classList.toggle('active');
            if (!isMultiSelect) cy.elements().unselect();
        }

        // --- å‚™ä»½ç³»çµ± ---
        function openBackupModal() {
            const data = { title: document.getElementById('edit-title').value, elements: cy.elements().map(ele => ({ group: ele.isNode() ? 'nodes' : 'edges', data: ele.data(), position: ele.isNode() ? ele.position() : undefined })) };
            document.getElementById('backup-data').value = JSON.stringify(data);
            document.getElementById('backup-modal').style.display = 'flex';
        }

        async function copyBackupText() {
            const txt = document.getElementById('backup-data').value;
            try {
                await navigator.clipboard.writeText(txt);
                alert("å·²è¤‡è£½ä»£ç¢¼ï¼è«‹è²¼åˆ° Notion å­˜æ”¾ã€‚");
            } catch (err) {
                const area = document.getElementById('backup-data');
                area.select(); document.execCommand('copy');
                alert("å·²è¤‡è£½ï¼");
            }
        }

        function importFromText() {
            try {
                const parsed = JSON.parse(document.getElementById('backup-data').value);
                document.getElementById('edit-title').value = parsed.title || "åŒ¯å…¥ç­†è¨˜";
                initCy(parsed.elements);
                document.getElementById('backup-modal').style.display = 'none';
            } catch (e) { alert("æ ¼å¼éŒ¯èª¤ï¼"); }
        }

        // --- ç®¡ç†é‚è¼¯ ---
        function saveAndExit() {
            const elementsData = cy.elements().map(ele => ({ group: ele.isNode() ? 'nodes' : 'edges', data: ele.data(), position: ele.isNode() ? ele.position() : undefined }));
            const noteObj = { id: currentNoteId, title: document.getElementById('edit-title').value || "æœªå‘½å", tag: "æœªåˆ†é¡", data: elementsData };
            const idx = notes.findIndex(n => n.id === currentNoteId);
            if(idx > -1) notes[idx] = noteObj; else notes.unshift(noteObj);
            localStorage.setItem('km_notion_v1', JSON.stringify(notes));
            document.getElementById('home-overlay').style.display = 'flex';
            document.getElementById('editor-view').style.display = 'none';
            renderCards();
        }

        function openNote(id) {
            const note = notes.find(n => n.id === id); currentNoteId = id;
            document.getElementById('edit-title').value = note.title;
            document.getElementById('home-overlay').style.display = 'none';
            document.getElementById('editor-view').style.display = 'flex';
            initCy(note.data); setTimeout(() => cy.fit(undefined, 50), 100);
        }

        function createNewNote() {
            currentNoteId = Date.now().toString();
            document.getElementById('home-overlay').style.display = 'none';
            document.getElementById('editor-view').style.display = 'flex';
            initCy([{ data: { id: 'root', label: 'ä¸­å¿ƒä¸»é¡Œ' }, position: {x:200, y:300} }]);
        }

        function renderSidebar() {
            const list = document.getElementById('tag-list'); list.innerHTML = '';
            tags.forEach(t => {
                list.innerHTML += `<div class="sidebar-item ${currentTagFilter === t ? 'active' : ''}" onclick="switchTag('${t}')">ğŸ·ï¸ ${t} <span onclick="removeTag('${t}', event)">Ã—</span></div>`;
            });
        }
        function addTag() { const input = document.getElementById('new-tag-input'); if(input.value) { tags.push(input.value); localStorage.setItem('km_tags_notion_v1', JSON.stringify(tags)); input.value = ''; renderSidebar(); } }
        function removeTag(t, e) { e.stopPropagation(); tags = tags.filter(tag => tag !== t); localStorage.setItem('km_tags_notion_v1', JSON.stringify(tags)); renderSidebar(); }
        function switchTag(t) { currentTagFilter = t; renderSidebar(); renderCards(); }

        function renderCards() {
            const grid = document.getElementById('cardGrid'); grid.innerHTML = '';
            notes.forEach(n => {
                const card = document.createElement('div'); card.className = 'note-card'; card.onclick = () => openNote(n.id);
                card.innerHTML = `<span class="card-del-btn" onclick="event.stopPropagation();deleteNote('${n.id}')">âœ•</span><h3 style="margin:0; font-size:14px;">${n.title}</h3>`;
                grid.appendChild(card);
            });
        }
        function deleteNote(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { notes = notes.filter(n => n.id !== id); localStorage.setItem('km_notion_v1', JSON.stringify(notes)); renderCards(); } }

        function addNode(type) {
            const sel = cy.$(':selected')[0] || cy.nodes()[0]; const id = 'n' + Date.now();
            cy.add([{ group: 'nodes', data: { id, label: 'æ–°é»' }, position: { x: sel.position().x + 100, y: sel.position().y + 50 } }, { group: 'edges', data: { source: sel.id(), target: id } }]);
        }
        function removeSelected() { cy.$(':selected').remove(); }

        window.onload = () => { renderSidebar(); renderCards(); };
    </script>
</body>
</html>
