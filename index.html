<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeepMind Pro - ç­†è¨˜ç®¡ç†åŒ¯å‡ºå¢å¼·ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        :root { --sidebar-w: 240px; --primary: #fb0; --bg: #f1f3f4; --danger: #ff4d4f; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: #3c4043; overflow: hidden; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: var(--sidebar-w); background: white; padding: 20px 0; display: flex; flex-direction: column; border-right: 1px solid #ddd; flex-shrink: 0; }
        .sidebar-header { padding: 0 20px 20px; font-size: 24px; font-weight: bold; color: var(--primary); }
        .sidebar-item { padding: 12px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; font-size: 14px; border-radius: 0 25px 25px 0; margin-bottom: 2px; }
        .sidebar-item:hover { background: #f1f3f4; }
        .sidebar-item.active { background: #feefc3; color: #e37400; font-weight: bold; }
        .tag-delete { color: #ccc; font-size: 12px; margin-left: 10px; }
        .tag-delete:hover { color: var(--danger); }
        .add-tag-box { padding: 15px 20px; border-top: 1px solid #eee; margin-top: auto; }
        .add-tag-box input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; }

        /* ä¸»ç•«é¢å¡ç‰‡ */
        .main-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
        .note-card { background: white; border: 1px solid #dadce0; border-radius: 12px; padding: 20px; cursor: pointer; position: relative; transition: 0.3s; height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
        .note-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .note-card h4 { margin: 0; font-size: 16px; color: #202124; line-height: 1.4; }
        .card-delete-btn { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; background: #fff; border: 1px solid #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.2s; color: #999; }
        .note-card:hover .card-delete-btn { opacity: 1; }
        .card-delete-btn:hover { background: var(--danger); color: white; border: none; }
        .tag-badge { background: #f1f3f4; font-size: 11px; padding: 2px 8px; border-radius: 10px; width: fit-content; }

        /* ç·¨è¼¯å™¨ä»‹é¢ */
        #editor-overlay { position: fixed; inset: 0; background: white; z-index: 1000; display: none; flex-direction: column; }
        .editor-header { padding: 12px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #eee; background: #fff; }
        .editor-header button { padding: 8px 14px; border-radius: 6px; border: 1px solid #dadce0; background: #fff; cursor: pointer; font-size: 14px; }
        .btn-primary { background: var(--primary) !important; border-color: var(--primary) !important; font-weight: bold; }
        .btn-export { background: #1a73e8 !important; color: white !important; border: none !important; }
        .btn-danger { color: var(--danger) !important; border: none !important; }

        .editor-body { display: flex; flex-grow: 1; overflow: hidden; }
        .text-panel { width: 320px; border-right: 1px solid #eee; display: flex; flex-direction: column; background: #fff; }
        #text-outline { flex-grow: 1; padding: 20px; border: none; font-family: monospace; font-size: 15px; line-height: 1.6; resize: none; outline: none; }
        .canvas-panel { flex-grow: 1; position: relative; background: #fafafa; }
        #cy { width: 100%; height: 100%; background: #fff; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); border-radius: 28px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100; transition: 0.2s; }
        .fab:hover { transform: scale(1.1); }

        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .text-panel { display: none; } /* æ‰‹æ©Ÿç‰ˆé è¨­éš±è—æ–‡å­—é¢ç‰ˆå¢åŠ ç•«åœ–ç©ºé–“ */
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">KeepMind</div>
        <div class="sidebar-item active" id="all-notes-tab" onclick="switchTag('all')">ğŸ“ å…¨éƒ¨ç­†è¨˜</div>
        <div id="tag-list"></div>
        <div class="add-tag-box">
            <input type="text" id="new-tag-input" placeholder="+ æ–°å¢æ¨™ç±¤..." onkeypress="if(event.key==='Enter') addTag()">
        </div>
    </div>

    <div class="main-content">
        <div class="card-container" id="cardGrid"></div>
        <div class="fab" onclick="createNewNote()">ï¼‹</div>
    </div>

    <div id="editor-overlay">
        <div class="editor-header">
            <button class="btn-primary" onclick="saveAndExit()">â† å„²å­˜è¿”å›</button>
            <input type="text" id="edit-title" style="flex-grow:1; font-size:18px; border:none; outline:none;" placeholder="æœªå‘½åå¿ƒæ™ºåœ–">
            <select id="edit-tag-select" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;"></select>
            <button class="btn-export" onclick="exportImage()">ğŸ“¥ åŒ¯å‡ºåœ–ç‰‡</button>
            <button class="btn-danger" onclick="deleteInEditor()">ğŸ—‘ åˆªé™¤</button>
        </div>
        <div class="editor-body">
            <div class="text-panel">
                <textarea id="text-outline" placeholder="åœ¨æ­¤è¼¸å…¥å¤§ç¶±...&#10;ä½¿ç”¨ã€Œç©ºæ ¼ã€ç¸®æ’ä¾†å€åˆ†éšå±¤" oninput="syncToMap()"></textarea>
                <div style="padding:10px; font-size:11px; color:#999; border-top:1px solid #eee;">é›™å‘åŒæ­¥ï¼šä¿®æ”¹æ–‡å­—æˆ–æ‹–å‹•åœ–è¡¨çš†å¯è‡ªå‹•åŒæ­¥</div>
            </div>
            <div class="canvas-panel">
                <div id="cy"></div>
            </div>
        </div>
    </div>

    <script>
        let notes = JSON.parse(localStorage.getItem('km_notes') || '[]');
        let tags = JSON.parse(localStorage.getItem('km_tags') || '["å·¥ä½œ", "ç”Ÿæ´»", "å­¸ç¿’"]');
        let currentNoteId = null;
        let cy = null;
        let isSyncing = false;
        let currentFilter = 'all';

        // --- åˆå§‹åŒ–èˆ‡æ¨™ç±¤æ¸²æŸ“ ---
        function renderSidebar() {
            const list = document.getElementById('tag-list');
            const select = document.getElementById('edit-tag-select');
            list.innerHTML = '';
            select.innerHTML = '<option value="æœªåˆ†é¡">æœªåˆ†é¡</option>';
            tags.forEach(t => {
                list.innerHTML += `<div class="sidebar-item ${currentFilter === t ? 'active' : ''}" onclick="switchTag('${t}')">ğŸ·ï¸ ${t} <span class="tag-delete" onclick="deleteTag('${t}', event)">âœ•</span></div>`;
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        function switchTag(tag) {
            currentFilter = tag;
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            if(tag === 'all') document.getElementById('all-notes-tab').classList.add('active');
            renderSidebar();
            renderCards(tag);
        }

        function addTag() {
            const input = document.getElementById('new-tag-input');
            const val = input.value.trim();
            if(val && !tags.includes(val)) {
                tags.push(val);
                localStorage.setItem('km_tags', JSON.stringify(tags));
                input.value = '';
                renderSidebar();
            }
        }

        function deleteTag(t, e) {
            e.stopPropagation();
            if(confirm(`ç¢ºå®šåˆªé™¤æ¨™ç±¤ã€Œ${t}ã€ï¼Ÿ`)) {
                tags = tags.filter(tag => tag !== t);
                localStorage.setItem('km_tags', JSON.stringify(tags));
                renderSidebar();
            }
        }

        // --- æ ¸å¿ƒç¹ªåœ–èˆ‡åŒæ­¥é‚è¼¯ ---
        function initCy(elements = []) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    { selector: 'node', style: {
                        'label': 'data(label)', 'background-color': '#fff', 'border-width': 2, 'border-color': '#fb0',
                        'shape': 'round-rectangle', 'width': 'label', 'height': 'label', 'padding': '12px',
                        'text-valign': 'center', 'font-size': '13px', 'font-family': 'system-ui'
                    }},
                    { selector: 'node:selected', style: { 'border-width': 4, 'border-color': '#333' }},
                    { selector: 'edge', style: { 'width': 2, 'line-color': '#ddd', 'curve-style': 'taxi', 'target-arrow-shape': 'none' }}
                ],
                layout: { name: 'breadthfirst', directed: true, padding: 30 }
            });

            cy.on('tap', 'node', function(e){
                let newLabel = prompt("ç·¨è¼¯ç¯€é»å…§å®¹:", e.target.data('label'));
                if(newLabel !== null) {
                    e.target.data('label', newLabel);
                    syncToText();
                }
            });

            cy.on('dragfree', () => { if(!isSyncing) syncToText(); });
        }

        function syncToText() {
            if (isSyncing) return;
            isSyncing = true;
            let root = cy.$('#root').length ? cy.$('#root') : cy.nodes()[0];
            if(!root) { isSyncing = false; return; }
            let output = "";
            function traverse(node, depth) {
                output += "  ".repeat(depth) + node.data('label') + "\n";
                node.outgoers('node').forEach(child => traverse(child, depth + 1));
            }
            traverse(root, 0);
            document.getElementById('text-outline').value = output.trimEnd();
            isSyncing = false;
        }

        function syncToMap() {
            if (isSyncing) return;
            isSyncing = true;
            const lines = document.getElementById('text-outline').value.split('\n');
            let newElements = [];
            let stack = [];
            lines.forEach((line, i) => {
                let content = line.trim();
                if(!content) return;
                let depth = line.search(/\S/);
                let id = i === 0 ? 'root' : 'n' + Date.now() + i;
                newElements.push({ data: { id, label: content }});
                while(stack.length > 0 && stack[stack.length-1].depth >= depth) stack.pop();
                if(stack.length > 0) newElements.push({ data: { source: stack[stack.length-1].id, target: id }});
                stack.push({ id, depth });
            });
            if(newElements.length) {
                cy.json({ elements: newElements });
                cy.layout({ name: 'breadthfirst', directed: true, spacingFactor: 1.1 }).run();
            }
            isSyncing = false;
        }

        // --- åŒ¯å‡ºåœ–ç‰‡ ---
        function exportImage() {
            if(!cy) return;
            const pngContent = cy.png({ full: true, bg: 'white', scale: 2 });
            const link = document.createElement('a');
            link.download = (document.getElementById('edit-title').value || 'MindMap') + '.png';
            link.href = pngContent;
            link.click();
        }

        // --- ç­†è¨˜ç®¡ç†èˆ‡å­˜æª” ---
        function renderCards(filter = 'all') {
            const grid = document.getElementById('cardGrid');
            grid.innerHTML = '';
            const filteredNotes = notes.filter(n => filter === 'all' || n.tag === filter);
            filteredNotes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.onclick = () => openNote(note.id);
                card.innerHTML = `
                    <div class="card-delete-btn" onclick="confirmDelete('${note.id}', event)">âœ•</div>
                    <h4>${note.title || "ç„¡æ¨™é¡Œ"}</h4>
                    <span class="tag-badge">${note.tag || "æœªåˆ†é¡"}</span>
                `;
                grid.appendChild(card);
            });
        }

        function createNewNote() {
            currentNoteId = 'km_' + Date.now();
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-tag-select').value = 'æœªåˆ†é¡';
            document.getElementById('text-outline').value = 'ä¸­å¿ƒä¸»é¡Œ';
            document.getElementById('editor-overlay').style.display = 'flex';
            initCy([{ data: { id: 'root', label: 'ä¸­å¿ƒä¸»é¡Œ' } }]);
            syncToMap();
        }

        function openNote(id) {
            const note = notes.find(n => n.id === id);
            if(!note) return;
            currentNoteId = id;
            document.getElementById('edit-title').value = note.title;
            document.getElementById('edit-tag-select').value = note.tag || 'æœªåˆ†é¡';
            document.getElementById('text-outline').value = note.rawText || '';
            document.getElementById('editor-overlay').style.display = 'flex';
            initCy(note.data);
            setTimeout(() => cy.fit(), 100);
        }

        function saveAndExit() {
            const noteObj = {
                id: currentNoteId,
                title: document.getElementById('edit-title').value.trim() || "æœªå‘½åå¿ƒæ™ºåœ–",
                tag: document.getElementById('edit-tag-select').value,
                data: cy.json().elements,
                rawText: document.getElementById('text-outline').value,
                updated: Date.now()
            };
            const idx = notes.findIndex(n => n.id === currentNoteId);
            if(idx > -1) notes[idx] = noteObj; else notes.unshift(noteObj);
            localStorage.setItem('km_notes', JSON.stringify(notes));
            document.getElementById('editor-overlay').style.display = 'none';
            renderCards(currentFilter);
        }

        function confirmDelete(id, e) {
            if(e) e.stopPropagation();
            if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ä»½ç­†è¨˜å—ï¼Ÿ")) {
                notes = notes.filter(n => n.id !== id);
                localStorage.setItem('km_notes', JSON.stringify(notes));
                renderCards(currentFilter);
            }
        }

        function deleteInEditor() {
            if(confirm("ç¢ºå®šåˆªé™¤é€™ä»½ç­†è¨˜ä¸¦é€€å‡ºï¼Ÿ")) {
                notes = notes.filter(n => n.id !== currentNoteId);
                localStorage.setItem('km_notes', JSON.stringify(notes));
                document.getElementById('editor-overlay').style.display = 'none';
                renderCards(currentFilter);
            }
        }

        window.onload = () => { renderSidebar(); renderCards(); };
    </script>
</body>
</html>
